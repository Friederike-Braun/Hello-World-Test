pipeline{
  agent any
  tools {
          maven "3.6.3"
          jdk "JDK-17"
  }

  stages{
    stage('Build'){
        steps {
            sh 'mvn compile test-compile'
        }
    }
    stage ('Test') {
        steps {
            // -Dmaven.test.failure.ignore=true causes maven to ignore any failed tests & continue with further goals
            sh 'mvn -Dmaven.test.failure.ignore=true test'
        }
        post {
            always {
                junit 'target/surefire-reports/**/*.xml'
            }
            unstable {
                //sh 'mvn clean'
                error('Build unstable, at least one test failed. Aborting pipeline')
            }
        }
    }
    stage('Package'){
        steps {
            sh 'mvn clean -Dmaven.test.skip package'
        }
    }
  }
  post{
    failure {
        sh 'mvn clean'
    }
  }
}